<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONTACT</title>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <style>
  * {margin: 0; padding: 0;}
  li {list-style: none;}
  a {text-decoration: none;}
  body {font-family: "Segoe UI", Arial, sans-serif;}

  .modal_3 {
  width: 1890px;
  height: 923px;
  margin: 0 auto;
  padding: 5px;
  border-radius: 5px;
  overflow-x: hidden;
}
.tit .btn_a img {width: 15px; height: 15px; margin-right: 5px;}

.tit {display: flex; width: 1888px; height: 40px; background-color: lightblue;}
.tit img {margin-left: 5px; margin-top: 5px; width: 30px; height: 30px;}
.tit p {margin-left: 10px; margin-top: 15px; font-size: 16px; line-height: .5;}
.tit button {
    position: relative;
    left: 1655px;
    width: 30px;
    height: 30px;
    border: none;
  margin: 5px;
  background: lightblue;
}
.tit button:hover {background-color: darkgrey;}
.tit .btn1:hover {background-color: red; color: #fff;}

.guestbook_form {
  padding: 20px;
  background: #fff;
}
.guestbook {
  position: relative;
  left: 520px;
  width: 800px;
  height: 300px;
  border-radius: 5px;
  border: 1px solid #ccc;
  background: lightblue;
}
.guestbook_form h1 {text-align: center; font-size: 40px; margin-bottom: 10px;}
.guestbook_form p {font-size: 20px; font-weight: bold; margin: 10px 20px;}
.guestbook_form input {
  padding: 10px;
  border-radius: 5px;
  font-size: 18px;
  width: 100%; 
  max-width: 100%; 
  font-family: "Segoe UI", Arial, sans-serif;
  box-sizing: border-box;
  border: none;
}
.guestbook_form textarea {
  padding: 10px;
  border-radius: 5px;
  font-size: 18px;
  width: 100%; 
  height: 170px;
  font-family: "Segoe UI", Arial, sans-serif;
  box-sizing: border-box;
  border: none;
}
.guestbook_form .btn {
  float: right;
  margin-right: 20px;
  width: 60px;
  height: 40px;
  border-radius: 5px;
  font-size: 20px;
  border: none;
  cursor: pointer;
  background: #fff;
  color: #000;
  font-family: "Segoe UI", Arial, sans-serif;
}
.guestbook_form button:hover {background: steelblue; color: #fff;}

.message_board {border-top: 1px solid silver; margin-top: 50px;}
.message_board h2 {position: relative; left: 520px; font-size: 40px; margin-top: 20px;}
.messages_list {list-style-type: none; padding: 0;}

#messages_list li {
  position: relative;
  left: 520px;
  width: 780px;
  height: 170px;
  margin: 20px 0;
  padding: 10px;
  background: lightblue;
  border: 1px solid #ccc;
  border-radius: 5px;
}
#messages_list button {
  position: relative;
  left: 670px;
  top: 10px;
  margin-left: 10px;
  width: 40px;
  height: 30px;
  border: none;
  cursor: pointer;
  border-radius: 5px;
  background-color: #fff;
  color: #000;
  font-family: 'GangwonEduSaeeum_OTFMediumA';
  font-size: 16px;
}
#messages_list button:hover {
  background: steelblue;
  color: #fff;
}
#messages_list li .text {
  display: flex;
  justify-content: space-between;
  border-bottom: 2px solid #fff;
}
#messages_list li strong {
  font-size: 20px;
  margin: 5px 5px;
}
#messages_list li p {margin: 5px 10px; font-size: 16px;}
#messages_list li .msg {
  padding: 10px;
  width: 760px;
  position: relative;
  right: 10px;
  overflow-x: hidden;
  height: 50px;
}
  </style>

</head>
<body>
  <div class="modal_3">
    <div class="tit">
      <img src="./images/CONTACT.png" alt="">
      <p>CONTACT</p>
      <button>_</button>
      <button class="btn_a"><img src="./images/전체화면.png" alt=""></button>
      <button class="btn1">X</button>
    </div>
    <div class="guestbook_form">
      <h1>방명록</h1>
      <form id="guestbook" class="guestbook">
        <p><input type="text" id="name" required placeholder="이름" /></p>
        <p><textarea id="message" placeholder="메시지"></textarea></p>
        <button class="btn" type="submit">전송</button>
      </form>
      <div class="message_board">
        <h2>게시판</h2>
        <ul id="messages_list"></ul>
      </div>
    </div>
  </div>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAaSybKMqwOIr4ODtCWG6-Wb_Ufvqv_Z1k",
      authDomain: "guest-book-3acdd.firebaseapp.com",
      databaseURL: "https://guest-book-3acdd-default-rtdb.firebaseio.com",
      projectId: "guest-book-3acdd",
      storageBucket: "guest-book-3acdd.firebasestorage.app",
      messagingSenderId: "559383552501",
      appId: "1:559383552501:web:4c5143c0666332580040bc",
      measurementId: "G-BNR8NWDHX2"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 방명록 폼 제출 처리
    document.addEventListener("DOMContentLoaded", function () {
      displayMessages(); // 페이지 로드 시 기존 메시지 불러오기

      document.getElementById('guestbook').addEventListener('submit', function (event) {
        event.preventDefault(); // 새로고침 방지

        const name = document.getElementById('name').value;
        const message = document.getElementById('message').value;

        if (name && message) {
          const messageObj = {
            name,
            message,
            date: new Date().toLocaleString(),
            id: Date.now()  // id를 고유하게 설정
          };

          // Firebase에 메시지 저장
          const newMessageRef = database.ref('messages').push();
          newMessageRef.set(messageObj).then(() => {
            displayMessages(); // 메시지 표시
            resetForm(); // 폼 초기화
          }).catch((error) => {
            alert('메시지 전송 실패: ' + error.message);
          });
        } else {
          alert("이름과 메시지를 모두 입력해주세요.");
        }
      });

      // Firebase에서 방명록 메시지를 실시간으로 가져오기
      const messagesRef = database.ref('messages');
      messagesRef.on('child_added', function(snapshot) {
        const msg = snapshot.val();
        const messageItem = document.createElement('li');
        messageItem.innerHTML = `
          <div class="text">
            <strong>${msg.name}</strong>
            <p>${msg.date}</p> 
          </div>
          <p class="msg">${msg.message}</p>
          <button class="edit" onclick="editMessage('${snapshot.key}')">수정</button>
          <button class="delete" onclick="deleteMessage('${snapshot.key}')">삭제</button>
        `;
        document.getElementById('messages_list').appendChild(messageItem);
      });

      // 메시지 수정 처리
      window.editMessage = function(key) {
        const messageRef = database.ref('messages/' + key);
        messageRef.once('value', function(snapshot) {
          const msg = snapshot.val();
          document.getElementById('name').value = msg.name;
          document.getElementById('message').value = msg.message;
          
          // 기존 메시지 삭제 후 수정
          deleteMessage(key);
        });
      };

      // 메시지 삭제 처리
      window.deleteMessage = function(key) {
        const messageRef = database.ref('messages/' + key);
        messageRef.remove().then(() => {
          displayMessages(); // 메시지 목록 갱신
        }).catch((error) => {
          alert('메시지 삭제 실패: ' + error.message);
        });
      };

      // 폼 초기화 함수
      function resetForm() {
        document.getElementById('name').value = '';
        document.getElementById('message').value = '';
      }

      // 기존 메시지 로드 함수
      function displayMessages() {
        const messagesList = document.getElementById('messages_list');
        messagesList.innerHTML = ''; // 기존 목록 지우기

        // Firebase에서 모든 메시지 불러오기
        database.ref('messages').once('value', function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            const msg = childSnapshot.val();
            const messageItem = document.createElement('li');
            messageItem.innerHTML = `
              <div class="text">
                <strong>${msg.name}</strong>
                <p>${msg.date}</p>
              </div>
              <p class="msg">${msg.message}</p>
              <button class="edit" onclick="editMessage('${childSnapshot.key}')">수정</button>
              <button class="delete" onclick="deleteMessage('${childSnapshot.key}')">삭제</button>
            `;
            messagesList.appendChild(messageItem);
          });
        });
      }
    });
  </script>

<script>
  $(function() {
    $(".btn_a").on("click", function() {
      window.location.href = 'mainPage.html?modal_3=true';
  });
});
</script>

<script>
  $(function(){
$(".btn1").on("click",function(){
  window.location.href = 'mainPage.html';
  })
});
</script>
</body>
</html>